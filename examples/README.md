# __TEST kg4vasp__

## First things first

It is important to patch kgec_2_1 and vasp_5_4_4

1. in  PATCHES/kgec_code_v2_1/kgec.patch: patch to enable kgec to write nabla file in the format read by kg4vasp
2. in PATCHES/vasp_5_4_4/optics.patch: patch to enable VASP to write on default file 'nabla.dat' the matrix elements.

	* in *makefile.include*, It has to be used the pre-pocessor flag: a) **-DNABLA1** if you want *nabla.dat* to be written in ASCII human readable format; b) or **-DNABLA_bin** if you want the file in binary unformatted style.

	* if you want also *OPTICS* calculations flag **-DOPT1** has to be also included.

## __TEST__

1) enter 01_QE dir (calculate and compare transport properties with QE and kgec, for the purpose of this example 1 core is enough):
	* mpirun -n 1 /where/qe/dir/is/bin/pw.x <  Al.in  > Al.out
	* mpirun -n 1 /where/kgec_2_1/dir/is/forxxx/kgec.x < kgec.x < kgec.in > kgec.out
	* remember to activate the flag for writing the matrix elements on a file: *writegm=.true.*

2) enter 02_LDA_PAW_nobin (calculate transport properties with VASP and kg4vasp, file nabla.dat in ASCII):

	* check the file **INPUT** to setup parameters for kg4vasp calc.: in particular NABLA_BIN=FALSE
	* cp INCAR_SCF INCAR
	* mpirun -n 1 /where/vasp_5_4_4/dir/is/bin/vasp_std > vasp_scf
	* cp INCAR_nabla INCAR
	* mpirun -n 1 /where/vasp_5_4_4/dir/is/bin/vasp_std > vasp_nabla
	* /where/is/kg4vasp/dir/is/bin/kg4vasp.x

3) enter 03_LDA_PAW_bin (calculate transport properties with VASP and kg4vasp, file nabla.dat in unformatted binary):

	* check the file **INPUT** to setup parameters for kg4vasp calc.: in particular NABLA_BIN=TRUE
	* cp INCAR_SCF INCAR
	* mpirun -n 1 /where/vasp_5_4_4/dir/is/bin/vasp_std > vasp_scf
	* cp INCAR_nabla INCAR; mv OUTCAR OUTCAR_SCF
	* mpirun -n 1 /where/vasp_5_4_4/dir/is/bin/vasp_std > vasp_nabla
	* mv OUTCAR OUTCAR_nabla
	* /where/is/kg4vasp/dir/is/bin/kg4vasp.x
	* compare generated files with \*\_ref files
4) enter 04_kg4vasp_on_QE (calculate data with kg4vasp from QE/kgec matrix elements):
	* check file **INPUT** in particular:  **FROM_VASP=FALSE**,  **FERMI_ENERGY from QE SCF calc. in eV** and **FILE_NABLA with the name of the file generated by kgec**.
	* copy file **psi_grad_psi-\*\*** from **01_QE** in here, create **INPUT** accordingly
	* run /where/is/kg4vasp/dir/is/bin/kg4vasp.x
	* compare **data_transport.dat_ref** with data in **01_QE/kgec.out**.
	* compare trace $\sigma (\omega)$ **elec_conductivity_vs_freq.dat_ref** and **01_QE/sigma1-tensor-1g.dat_ref** (e.g. gnuplot displaying columns 1 and 11)
